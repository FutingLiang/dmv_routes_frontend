# 批次匯入 114 年客運資料

本工具用於將公路局 114 年客運路線表 Excel 檔案批次匯入 PostgreSQL 資料庫。

## 功能特色

- 🔍 自動掃描並識別符合條件的 Excel 檔案
- 🏷️ 根據檔名自動判斷區域與路線類型
- 🧹 智能清理與標準化欄位名稱和資料
- 📊 建立具適當資料類型的 PostgreSQL 資料表
- 📝 輸出詳細的匯入結果報表
- 🛡️ 錯誤處理與逐行插入機制

## 系統需求

- **作業系統**: Windows
- **Python**: 3.9+
- **資料庫**: PostgreSQL

## 安裝相依套件

```bash
pip install pandas numpy sqlalchemy psycopg2-binary pytz openpyxl
```

或使用 requirements.txt：

```bash
pip install -r requirements.txt
```

### requirements.txt 內容
```
pandas>=2.0.0
numpy>=1.24.0
SQLAlchemy>=2.0.0
psycopg2-binary>=2.9.0
pytz>=2023.3
openpyxl>=3.1.0
```

## 設定與使用

### 1. 資料夾準備
將 Excel 檔案放置於：
```
C:\Users\root\Desktop\114公路總局_客運路線表
```

### 2. 檔案命名規則
Excel 檔名必須包含：
- 年份關鍵字：`114`
- 類型關鍵字：`路線` 或 `route`
- 區域關鍵字：`臺北`/`台北`/`新竹`/`臺中`/`台中`/`嘉義`/`高雄`
- 路線類型：`國道` 或 `一般公路`/`一般客運`/`一般`

**範例檔名**：
- `114台北_一般路線_資料.xlsx`
- `route_114_高雄_國道.xlsx`

### 3. 資料庫連線設定
修改程式中的資料庫連線字串：
```python
engine = create_engine('postgresql+psycopg2://使用者:密碼@主機:5432/資料庫名稱')
```

### 4. 執行程式
```bash
python 批次匯入114年客運資料.py
```

## 資料表結構

程式會建立 `dmv_routes_2025` 資料表，包含以下欄位：

| 欄位名稱 | 資料類型 | 說明 |
|---------|----------|------|
| 公司名稱 | VARCHAR(100) | 客運公司名稱 |
| 路線編號 | VARCHAR(20) | 路線編號 |
| 路線名稱 | VARCHAR(200) | 路線名稱 |
| 里程往/里程返 | DECIMAL(10,2) | 往返里程數 |
| 班次一~班次日 | INTEGER | 各日班次數 |
| 補貼_路線 | VARCHAR(10) | 補貼路線標記 |
| 站牌數往/站牌數返 | INTEGER | 往返站牌數 |
| 車輛數 | INTEGER | 車輛數量 |
| 聯營業者 | VARCHAR(200) | 聯營業者資訊 |
| 路線性質 | VARCHAR(20) | 路線性質（機場/一般） |
| district | VARCHAR(20) | 區域代碼 |
| route_type | VARCHAR(20) | 路線類型 |
| source_file | VARCHAR(200) | 來源檔案名稱 |
| imported_at | VARCHAR(30) | 匯入時間戳記 |

## 區域與路線類型對照

### 區域對照
- `臺北市區`/`臺北`/`台北` → `taipei`
- `新竹` → `hsinchu`
- `臺中`/`台中` → `taichung`
- `嘉義` → `chiayi`
- `高雄` → `kaohsiung`

### 路線類型對照
- `國道` → `hwy_routes`
- `一般公路`/`一般客運`/`一般` → `local_routes`

## 輸出檔案

執行完成後會在資料夾中產生：

- `匯入成功清單.csv` - 成功匯入的檔案列表
- `匯入失敗清單.csv` - 匯入失敗的檔案與錯誤訊息
- `略過清單.csv` - 無法識別的檔案列表

## 注意事項

⚠️ **重要警告**：程式會先刪除目標資料表後重建，請確保已備份重要資料！

- 程式會自動處理 Excel 臨時檔案（`~$` 開頭）
- 支援不同工作表名稱，優先讀取「工作表1」
- 數值欄位會自動清理非數字字元
- 批次插入失敗時會自動切換為逐行插入模式
- 終端機會顯示即時處理狀態與最終統計

## 疑難排解

### 常見問題

1. **找不到資料夾**
   - 確認 `data_folder` 路徑是否正確
   - 檢查資料夾是否存在

2. **資料庫連線失敗**
   - 確認 PostgreSQL 服務是否啟動
   - 檢查連線字串中的使用者名稱、密碼、主機、埠號

3. **檔案無法識別**
   - 檢查檔名是否包含必要關鍵字
   - 參考檔案命名規則調整檔名

4. **資料插入失敗**
   - 程式會自動切換為逐行插入並顯示錯誤行號
   - 檢查 Excel 中是否有格式異常的資料

## 開發資訊

- **開發語言**: Python
- **主要套件**: pandas, SQLAlchemy
- **編碼**: UTF-8
- **時區**: Asia/Taipei
